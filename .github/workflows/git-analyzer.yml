name: Diff the startups content

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 1" # every monday

permissions:
  contents: read

jobs:
  analyze:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run diff startups
        run: ./ci/git-analyzer.sh ./content/_startups 30 startups.md

      - name: Run diff members
        run: ./ci/git-analyzer.sh ./content/_authors 30 members.md

      - name: Generate LLM summary for startups
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CONTENT=$(cat startups.md)

          PAYLOAD=$(jq -n \
            --arg content "$CONTENT" \
            '{
              "model": "mistral-small-3.2-24b-instruct-2506",
              "messages": [
                {
                  "role": "system",
                  "content": "Tu es un assistant qui rÃ©sume les changements dans un dÃ©pÃ´t Git pour le grand public, sans dÃ©tail technique. GÃ©nÃ¨re un rÃ©sumÃ© clair et lisible en franÃ§ais des modifications apportÃ©es aux fiches startups. Organise le rÃ©sumÃ© par type de changement (noveaux fichiers, mises Ã  jour, suppressions). Met les changements de phase en avant, ne manque aucune info importante, mentionne les URLs indiquÃ©es. Met toujours le lien URL de la startup autour de son nom https://beta.gouv.fr/startups/[id]."
                },
                {
                  "role": "user",
                  "content": $content
                }
              ],
              "temperature": 0.1
            }')

          RESPONSE=$(curl -s "${OPENAI_BASE_URL}/chat/completions" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > startups-summary.md

      - name: Generate LLM summary for members
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CONTENT=$(cat members.md)

          PAYLOAD=$(jq -n \
            --arg content "$CONTENT" \
            '{
              "model": "mistral-small-3.2-24b-instruct-2506",
              "messages": [
                {
                  "role": "system",
                  "content": "Tu es un assistant qui rÃ©sume les changements dans un dÃ©pÃ´t Git pour le grand public, sans dÃ©tail technique. GÃ©nÃ¨re un rÃ©sumÃ© clair et lisible en franÃ§ais des modifications apportÃ©es aux fiches membres. Organise un rÃ©sumÃ© concis comme suit : \n\n - ðŸŽ‰ liste des nouveaux membres, missions et startups\n - ðŸ“– changements de rÃ´les\n\nNe prend pas en compte les changements de date et prolongation de mission. Met toujours le lien URL des membres autour de leur nom https://espace-membre.incubateur.net/community/[username]."
                },
                {
                  "role": "user",
                  "content": $content
                }
              ],
              "temperature": 0.1
            }')

          RESPONSE=$(curl -s "${OPENAI_BASE_URL}/chat/completions" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "$RESPONSE" | jq -r '.choices[0].message.content' > members-summary.md

      - name: Convert to HTML
        run: |
          mkdir -p gh-pages
          cp startups.md  > ./gh-pages/
          cp startups-summary.md  > ./gh-pages/
          npx markdown-to-html-cli startups.md --output "gh-pages"
          npx markdown-to-html-cli startups-summary.md --output "gh-pages"
          cp members.md  > ./gh-pages/
          cp members-summary.md  > ./gh-pages/
          npx markdown-to-html-cli members.md --output "gh-pages"
          npx markdown-to-html-cli members-summary.md --output "gh-pages"

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: gh-pages
